<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>„Çø„Ç§„Éî„É≥„Ç∞„ÇØ„Ç®„Çπ„Éà</title>
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--red:#d03030;--green:#30a030;--blue:#3060c0;--gold:#d0a820;--correct:#30d030;--wrong:#d03030;--cursor:#d0a820;--txt:#d8d8d0;--dark:#0a0a12}
html,body{width:100%;height:100%;overflow:hidden;touch-action:manipulation}
body{font-family:'Press Start 2P','DotGothic16',monospace;image-rendering:pixelated;image-rendering:crisp-edges;-webkit-font-smoothing:none;-moz-osx-font-smoothing:unset;font-smooth:never;color:var(--txt);display:flex;align-items:center;justify-content:center;background:var(--dark)}
canvas#bg{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;image-rendering:pixelated;image-rendering:crisp-edges}
canvas#fx{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:100;image-rendering:pixelated}
.screen{display:none;flex-direction:column;align-items:center;justify-content:center;width:100%;max-width:760px;padding:14px;text-align:center;z-index:1;position:relative}
.screen.active{display:flex}
.panel{background:#101020;border:4px solid #f0f0e0;outline:4px solid #101020;padding:16px;margin:8px 0;width:100%;box-shadow:inset 0 0 0 2px #303048}
h1{font-size:24px;color:var(--gold);text-shadow:2px 2px 0 #000;margin-bottom:4px;line-height:1.6;letter-spacing:2px}
h2{font-size:16px;color:var(--txt);text-shadow:2px 2px 0 #000;margin-bottom:8px}
.subtitle{font-size:8px;color:#808080;margin-bottom:14px}
.btn{font-family:'Press Start 2P','DotGothic16',monospace;font-size:12px;padding:12px 24px;margin:5px;cursor:pointer;border:3px solid #f0f0e0;background:var(--blue);color:#f0f0e0;text-shadow:1px 1px 0 #000;box-shadow:inset -2px -2px 0 #1a3070,inset 2px 2px 0 #5080e0;outline:none}
.btn:active{box-shadow:inset 2px 2px 0 #1a3070,inset -2px -2px 0 #5080e0}
.btn-red{background:var(--red);box-shadow:inset -2px -2px 0 #701818,inset 2px 2px 0 #e05050}
.btn-green{background:var(--green);box-shadow:inset -2px -2px 0 #186018,inset 2px 2px 0 #50c050}
.btn-small{font-size:8px;padding:8px 12px}
.name-input{font-family:'Press Start 2P','DotGothic16',monospace;font-size:16px;padding:10px 14px;background:#000010;border:3px solid var(--gold);color:var(--gold);text-align:center;width:240px;outline:none;margin:8px 0;box-shadow:inset 2px 2px 0 #000}
.name-input::placeholder{color:rgba(208,168,32,0.25)}.name-input:focus{border-color:#e8c840}
/* Pixel icon inline */
.pxi{display:inline-block;vertical-align:middle;image-rendering:pixelated;image-rendering:crisp-edges}
.mon-canvas{image-rendering:pixelated;image-rendering:crisp-edges;width:80px;height:80px;margin:0 auto 4px}
.mon-canvas.hit{animation:hit8 .15s steps(2)}.mon-canvas.dead{animation:dead8 .5s steps(4) forwards}
.mon-name{font-size:12px;margin:2px 0;color:var(--gold);text-shadow:1px 1px 0 #000}
.mon-stage{font-size:8px;color:#606060;margin-bottom:3px}
.hp-wrap{width:60%;max-width:260px;margin:0 auto 8px;position:relative}
.hp-outer{height:12px;background:#181828;border:2px solid #484858;overflow:hidden}
.hp-inner{height:100%;background:var(--red);transition:width .2s steps(6)}
.hp-inner.low{background:#c07020}.hp-inner.crit{background:var(--red);animation:blink8 .25s steps(1) infinite}
.hp-txt{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:8px;text-shadow:1px 1px 0 #000;z-index:1;color:#f0f0e0}
.word-display{font-size:24px;letter-spacing:4px;padding:12px;min-height:50px;display:flex;align-items:center;justify-content:center;flex-wrap:wrap;gap:1px;background:#000010;border:3px solid #484858;margin-bottom:3px}
.char{display:inline-block;padding:1px 2px;border-bottom:3px solid transparent}
.char.correct{color:var(--correct);border-bottom-color:var(--correct)}
.char.wrong{color:var(--wrong);background:rgba(208,48,48,.15);border-bottom-color:var(--wrong)}
.char.current{color:#f0f0e0;border-bottom-color:var(--cursor);animation:blink8 .5s steps(1) infinite}
.char.pending{color:#7078b0}
.typing-hint{font-size:8px;color:#484858;margin-top:2px}
.stage-desc{font-size:8px;color:var(--blue);margin-bottom:4px}
#mobile-input{position:fixed;left:-9999px;top:0;width:1px;height:1px;opacity:0;font-size:16px}
.mobile-tap-hint{font-size:8px;color:var(--gold);margin:6px 0;padding:8px 16px;border:2px dashed var(--gold);cursor:pointer;display:none}
.is-mobile .mobile-tap-hint{display:inline-block}
.is-mobile .keyboard{display:none}
.keyboard{margin:8px auto;max-width:580px}
.kb-row{display:flex;justify-content:center;margin:2px 0;gap:2px}
.kb-key{font-size:8px;min-width:36px;height:28px;display:flex;align-items:center;justify-content:center;background:#282838;border:2px solid #404058;color:#707080}
.kb-key.active{background:var(--gold);color:#000;border-color:#a08018}
.kb-key.next-key{background:var(--green);color:#f0f0e0;border-color:#208020}
.kb-key.space{min-width:160px}.kb-key.wide{min-width:48px}
.stats-bar{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:4px;width:100%;padding:4px 8px;margin-bottom:4px;background:#101020;border:2px solid #303048}
.stat-item{font-size:8px;display:flex;align-items:center;gap:3px}
.stat-label{color:#606070}.stat-value{color:var(--gold)}
.xp-mini{width:60px;height:6px;background:#181828;border:1px solid #383848;overflow:hidden}
.xp-fill{height:100%;background:var(--green);transition:width .3s steps(6)}
.combo{font-size:10px;color:var(--gold);margin:2px 0;min-height:16px;text-shadow:1px 1px 0 #000}
.combo.fire{color:var(--red);animation:pop8 .15s steps(2)}
.combo.ultra{color:#a030d0;animation:pop8 .15s steps(2);font-size:14px}
.wpm-display{font-size:8px;color:var(--blue)}
.lu-num{font-size:56px;color:var(--gold);text-shadow:3px 3px 0 #000;animation:pop8 .2s steps(3)}
.lu-label{font-size:16px;color:var(--green);margin-bottom:6px;text-shadow:1px 1px 0 #000}
.lu-reward{font-size:10px;color:var(--blue);margin:5px 0}
.result-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:8px 0;width:100%}
.result-item{text-align:center;padding:8px;background:#101020;border:2px solid #303048}
.result-item .label{font-size:8px;color:#606070;margin-bottom:3px}
.result-item .value{font-size:16px;color:var(--gold)}
.ranking-list{width:100%;text-align:left}
.rank-entry{display:flex;justify-content:space-between;padding:5px 8px;border-bottom:1px solid #181828;font-size:8px}
.rank-entry.mine{background:rgba(208,168,32,.08);border:1px solid var(--gold)}
.rank-entry .rank{color:var(--gold);min-width:26px}.rank-entry .rname{flex:1;margin:0 8px}.rank-entry .rscore{color:var(--green)}
.free-input{font-family:'Press Start 2P','DotGothic16',monospace;font-size:10px;width:100%;padding:10px;background:#000010;border:2px solid #404058;color:var(--txt);resize:none;height:100px;outline:none}
.free-input:focus{border-color:var(--gold)}
.free-stats{display:flex;gap:14px;justify-content:center;margin-top:5px;font-size:8px;color:#606070}
.visitor-count{font-size:8px;color:#383848;margin-top:10px}
.scanlines{position:fixed;top:0;left:0;width:100%;height:100%;z-index:99;pointer-events:none;background:repeating-linear-gradient(0deg,transparent 0px,transparent 2px,rgba(0,0,0,.06) 2px,rgba(0,0,0,.06) 4px)}
@keyframes blink8{0%,100%{opacity:1}50%{opacity:0}}
@keyframes hit8{0%{transform:translate(0)}33%{transform:translate(-6px)}66%{transform:translate(6px)}100%{transform:translate(0)}}
@keyframes dead8{0%{opacity:1}25%{opacity:.7}50%{opacity:.4;transform:scale(.7)}100%{opacity:0;transform:scale(0)}}
@keyframes pop8{0%{transform:scale(1)}50%{transform:scale(1.25)}100%{transform:scale(1)}}
@keyframes shake8{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
.shake{animation:shake8 .15s steps(3)}
@media(max-width:600px){.panel{padding:10px}h1{font-size:16px}h2{font-size:12px}.word-display{font-size:18px}.keyboard{transform:scale(.82);transform-origin:center}.btn{font-size:10px;padding:10px 18px}.btn-small{font-size:8px;padding:6px 10px}}
.is-mobile #battle-screen.active{position:fixed;top:var(--vv-top,0px);left:0;right:0;height:var(--vh,100vh);max-height:var(--vh,100vh);z-index:10;padding:6px;overflow:hidden}
#battle-screen.kb-open{justify-content:flex-start;padding-top:2px;overflow:hidden}
#battle-screen.kb-open .stats-bar{display:none}
#battle-screen.kb-open .mon-stage{display:none}
#battle-screen.kb-open .mon-canvas{width:32px!important;height:32px!important}
#battle-screen.kb-open .mon-name{display:none}
#battle-screen.kb-open .hp-wrap{margin:0 auto 2px}
#battle-screen.kb-open .combo{font-size:7px;min-height:8px;margin:1px 0}
#battle-screen.kb-open .stage-desc{display:none}
#battle-screen.kb-open .btn-red{display:none}
#battle-screen.kb-open .panel{padding:4px;margin:2px 0}
#battle-screen.kb-open .word-display{font-size:14px;padding:6px;min-height:30px;letter-spacing:2px}
#battle-screen.kb-open .typing-hint{display:none}
#battle-screen.kb-open .mobile-tap-hint{display:none!important}
.is-mobile .mobile-tap-hint{display:none!important}
.is-mobile #mobile-input{position:static!important;left:auto!important;width:90%!important;max-width:400px;height:auto!important;opacity:1!important;font-family:'DotGothic16','Press Start 2P',monospace;font-size:20px;padding:10px 14px;background:#000010;border:3px solid var(--gold);color:var(--gold);caret-color:var(--gold);text-align:center;outline:none;margin:6px auto;display:block;box-shadow:inset 2px 2px 0 #000;-webkit-text-size-adjust:100%}
.is-mobile #mobile-input:focus{border-color:#e8c840}
.is-mobile #mobile-input::placeholder{color:rgba(208,168,32,0.3);font-size:12px}
#battle-screen.kb-open #mobile-input{font-size:16px;padding:6px 10px;margin:2px auto}
/* === SPECIAL MOVES === */
.skill-overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:200;pointer-events:none;display:none;flex-direction:column;align-items:center;justify-content:center;gap:8px}
.skill-overlay.active{display:flex}
.skill-flash{position:absolute;top:0;left:0;width:100%;height:100%;animation:skFlash .5s steps(4) forwards}
@keyframes skFlash{0%{background:var(--sk-c,#fff);opacity:.8}40%{opacity:.3}70%{background:#000;opacity:.7}100%{background:#000;opacity:.6}}
.skill-label{font-family:'Press Start 2P','DotGothic16',monospace;font-size:10px;color:#f0f0e0;text-shadow:2px 2px 0 #000;letter-spacing:6px;z-index:1;opacity:0;animation:skSlide .3s steps(4) .1s forwards}
.skill-name{font-family:'Press Start 2P','DotGothic16',monospace;font-size:22px;color:var(--sk-c,#d0a820);text-shadow:3px 3px 0 #000,0 0 30px var(--sk-c,#d0a820);z-index:1;opacity:0;animation:skPop .4s steps(4) .25s forwards;letter-spacing:4px}
.skill-dmg{font-family:'Press Start 2P','DotGothic16',monospace;font-size:40px;color:#f05050;text-shadow:3px 3px 0 #000;z-index:1;opacity:0;animation:skPop .3s steps(3) .55s forwards}
@keyframes skSlide{0%{opacity:0;transform:translateY(-20px)}100%{opacity:1;transform:translateY(0)}}
@keyframes skPop{0%{opacity:0;transform:scale(0)}60%{transform:scale(1.4)}100%{opacity:1;transform:scale(1)}}
.screen-shake{animation:screenShake .4s steps(4)}
@keyframes screenShake{0%,100%{transform:translate(0)}20%{transform:translate(-8px,4px)}40%{transform:translate(6px,-4px)}60%{transform:translate(-4px,6px)}80%{transform:translate(4px,-2px)}}
@media(max-width:600px){.skill-name{font-size:16px}.skill-dmg{font-size:28px}}
/* === MONSTER ATTACK SYSTEM === */
.atk-wrap{width:60%;max-width:260px;margin:2px auto 4px;position:relative}
.atk-outer{height:6px;background:#181828;border:2px solid #383848;overflow:hidden}
.atk-inner{height:100%;width:0%;background:#d0a820;transition:width .1s linear}
.atk-inner.warn{background:#d07020}
.atk-inner.danger{background:#d03030;animation:blink8 .2s steps(1) infinite}
.atk-label{font-size:5px;color:#484858;text-align:center;margin-top:1px}
.php-item{display:flex;align-items:center;gap:3px}
.php-txt{font-size:7px;color:#30a030}
.php-txt.low{color:#c07020}
.php-txt.crit{color:#d03030;animation:blink8 .3s steps(1) infinite}
.dmg-flash{position:fixed;top:0;left:0;width:100%;height:100%;z-index:150;pointer-events:none}
.dmg-flash.active{animation:dmgFlash .3s steps(3) forwards}
@keyframes dmgFlash{0%{background:rgba(208,48,48,0.4)}50%{background:rgba(208,48,48,0.2)}100%{background:transparent}}
.gameover-title{font-size:24px;color:#d03030;text-shadow:3px 3px 0 #000;letter-spacing:4px;margin-bottom:8px}
.gameover-sub{font-size:8px;color:#808080;margin:4px 0 10px}
/* === SHOP SYSTEM === */
.shop-gold{font-size:14px;color:var(--gold);text-shadow:2px 2px 0 #000;margin:4px 0}
.shop-tabs{display:flex;gap:4px;margin:6px 0;justify-content:center}
.shop-tab{font-family:'Press Start 2P','DotGothic16',monospace;font-size:8px;padding:6px 12px;cursor:pointer;border:2px solid #404058;background:#181828;color:#707080}
.shop-tab.active{background:var(--blue);color:#f0f0e0;border-color:#f0f0e0}
.shop-list{width:100%;margin:4px 0}
.shop-item{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border:2px solid #303048;margin:3px 0;cursor:pointer;background:#101020;transition:background .1s}
.shop-item:hover{background:#1a1a30;border-color:var(--gold)}
.shop-item.owned{opacity:.4;cursor:default;border-color:#303048}
.shop-item.cant-afford{opacity:.5}
.si-name{font-size:9px;color:var(--txt);flex:1}
.si-desc{font-size:7px;color:var(--blue);margin:0 8px}
.si-cost{font-size:9px;color:var(--gold);white-space:nowrap}
.si-cost.expensive{color:#d03030}
.shop-equip{font-size:7px;color:var(--green);margin-left:4px}
.shop-typing-area{margin:8px 0;width:100%;display:none}
.shop-typing-area.active{display:block}
.shop-word{font-size:20px;letter-spacing:4px;padding:8px;background:#000010;border:3px solid #484858;margin-bottom:4px;display:flex;align-items:center;justify-content:center;flex-wrap:wrap;gap:1px}
.shop-input{font-family:'DotGothic16','Press Start 2P',monospace;font-size:18px;padding:8px 12px;background:#000010;border:3px solid var(--gold);color:var(--gold);caret-color:var(--gold);text-align:center;outline:none;width:90%;max-width:300px;margin:4px auto;display:block;box-shadow:inset 2px 2px 0 #000}
.shop-input:focus{border-color:#e8c840}
.shop-hint{font-size:7px;color:#484858;margin:2px 0}
.discount-msg{font-size:9px;color:var(--green);margin:4px 0;min-height:16px;text-shadow:1px 1px 0 #000}
.discount-msg.fail{color:var(--red)}
.gold-stat{font-size:7px;color:var(--gold)}
.item-count{font-size:6px;color:var(--green);margin-left:3px}
.potion-btn{font-family:'Press Start 2P','DotGothic16',monospace;font-size:7px;padding:4px 8px;cursor:pointer;border:2px solid var(--green);background:#103010;color:var(--green);margin-left:4px}
.potion-btn:active{background:#205020}
.potion-btn.empty{opacity:.3;cursor:default;border-color:#303048;color:#303048}
#battle-screen.kb-open .atk-wrap{margin:0 auto 1px}
#battle-screen.kb-open .atk-label{display:none}
#mobile-input.pc-ime{position:static!important;left:auto!important;width:90%!important;max-width:400px;height:auto!important;opacity:1!important;font-family:'DotGothic16','Press Start 2P',monospace;font-size:16px;padding:8px 12px;background:#000010;border:3px solid var(--gold);color:var(--gold);caret-color:var(--gold);text-align:center;outline:none;margin:6px auto;display:block!important;box-shadow:inset 2px 2px 0 #000}
#mobile-input.pc-ime:focus{border-color:#e8c840}
#mobile-input.pc-ime::placeholder{color:rgba(208,168,32,0.3);font-size:12px}
</style>
</head>
<body>
<canvas id="bg"></canvas>
<canvas id="fx"></canvas>
<div class="scanlines"></div>
<div class="skill-overlay" id="skill-overlay"></div>
<div class="dmg-flash" id="dmg-flash"></div>
<input type="text" id="mobile-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">

<!-- TITLE -->
<div id="title-screen" class="screen active">
  <canvas id="title-icon" class="pxi" width="16" height="16" style="width:64px;height:64px"></canvas>
  <h1>„Çø„Ç§„Éî„É≥„Ç∞„ÇØ„Ç®„Çπ„Éà</h1>
  <p class="subtitle">- „Ç≠„Éº„Éú„Éº„Éâ„ÅÆ „ÇÜ„ÅÜ„Åó„ÇÉ -</p>
  <div class="panel" style="max-width:380px">
    <p style="font-size:8px;color:#a0a098;margin-bottom:10px">> „Å™„Åæ„Åà„Çí „ÅÑ„Çå„Å¶„Å≠</p>
    <input type="text" id="player-name" class="name-input" placeholder="„Å™„Åæ„Åà" maxlength="12" autofocus>
    <br>
    <div id="title-buttons"><button class="btn btn-green" onclick="Game.startAdventure()">„Åº„ÅÜ„Åë„Çì„Å´ „Åß„Çã</button></div>
    <br>
    <button class="btn btn-small" style="margin-top:5px" onclick="Game.showScreen('free-screen')">„Çå„Çì„Åó„ÇÖ„ÅÜ</button>
    <button class="btn btn-small" onclick="Game.showScreen('ranking-screen')">„Åç„Çç„Åè</button>
  </div>
  <div class="visitor-count" id="visitor-count"></div>
</div>

<!-- BATTLE -->
<div id="battle-screen" class="screen">
  <div class="stats-bar">
    <div class="stat-item"><span class="stat-label">LV</span><span class="stat-value" id="s-level">1</span></div>
    <div class="stat-item"><canvas class="pxi" data-icon="star" width="8" height="8" style="width:12px;height:12px"></canvas><div class="xp-mini"><div class="xp-fill" id="s-xp" style="width:0%"></div></div></div>
    <div class="stat-item"><canvas class="pxi" data-icon="fire" width="8" height="8" style="width:12px;height:12px"></canvas><span class="stat-value" id="s-streak">0</span></div>
    <div class="stat-item"><canvas class="pxi" data-icon="sword_sm" width="8" height="8" style="width:12px;height:12px"></canvas><span class="stat-value" id="s-words">0</span></div>
    <div class="stat-item wpm-display" id="s-wpm"></div>
    <div class="stat-item php-item"><canvas class="pxi" data-icon="heart" width="8" height="8" style="width:12px;height:12px"></canvas><span class="php-txt" id="s-php">100</span><button class="potion-btn empty" id="potion-btn" onclick="Game.usePotion()" title="„Éù„Éº„Ç∑„Éß„É≥">üíä0</button></div>
    <div class="stat-item"><span class="gold-stat" id="s-gold">üí∞0</span></div>
  </div>
  <div class="mon-stage" id="m-stage">STAGE 1</div>
  <canvas class="mon-canvas" id="m-canvas" width="16" height="16"></canvas>
  <div class="mon-name" id="m-name"></div>
  <div class="hp-wrap">
    <div class="hp-txt" id="m-hp-txt">HP 30/30</div>
    <div class="hp-outer"><div class="hp-inner" id="m-hp" style="width:100%"></div></div>
  </div>
  <div class="atk-wrap">
    <div class="atk-outer"><div class="atk-inner" id="m-atk" style="width:0%"></div></div>
    <div class="atk-label">„Å¶„Åç„ÅÆ „Åì„ÅÜ„Åí„Åç</div>
  </div>
  <div class="panel" style="padding:10px">
    <div class="combo" id="combo-text"></div>
    <div class="stage-desc" id="stage-desc"></div>
    <div class="word-display" id="word-display"></div>
    <div class="typing-hint" id="typing-hint"></div>
    <div class="mobile-tap-hint" id="mobile-tap" onclick="Game.focusInput()"> > „Çø„ÉÉ„Éó„Åó„Å¶ „Å´„ÇÖ„ÅÜ„Çä„Çá„Åè</div>
  </div>
  <div class="keyboard" id="keyboard"></div>
  <button class="btn btn-small btn-red" style="margin-top:5px" onclick="Game.backToTitle()">„Å´„Åí„Çã</button>
</div>

<!-- LEVEL UP -->
<div id="levelup-screen" class="screen">
  <div class="panel" style="max-width:360px">
    <div class="lu-label">LEVEL UP!</div>
    <div class="lu-num" id="lu-level">2</div>
    <div class="lu-reward" id="lu-reward"></div>
    <button class="btn btn-green" onclick="Game.continueBattle()">„Å§„Å•„Åë„Çã</button>
  </div>
</div>

<!-- STAGE CLEAR -->
<div id="stageclear-screen" class="screen">
  <div class="panel" style="max-width:410px">
    <h2>STAGE CLEAR!</h2>
    <div class="result-grid" id="stage-results"></div>
    <button class="btn btn-green" onclick="Game.openShop()">üè™ „Ç∑„Éß„ÉÉ„Éó„Å∏</button>
    <button class="btn btn-small" onclick="Game.nextStage()">„Çπ„Ç≠„ÉÉ„Éó ‚Üí</button>
  </div>
</div>


<!-- SHOP -->
<div id="shop-screen" class="screen">
  <div class="panel" style="max-width:440px">
    <h2>üè™ „Ç∑„Éß„ÉÉ„Éó</h2>
    <div class="shop-gold" id="shop-gold">üí∞ 0G</div>
    <div class="shop-tabs">
      <div class="shop-tab active" onclick="Game.shopTab('inn')" id="tab-inn">üè®„ÇÑ„Å©„ÇÑ</div>
      <div class="shop-tab" onclick="Game.shopTab('weapon')" id="tab-weapon">‚öîÔ∏è„Å∂„Åç„ÇÑ</div>
      <div class="shop-tab" onclick="Game.shopTab('item')" id="tab-item">üß™„Å©„ÅÜ„Åê</div>
    </div>
    <div class="shop-list" id="shop-list"></div>
    <div class="shop-typing-area" id="shop-typing-area">
      <div class="shop-hint" id="shop-buy-label"></div>
      <div class="shop-word" id="shop-word-display"></div>
      <input type="text" class="shop-input" id="shop-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="„Å≤„Çâ„Åå„Å™„Åß „ÅÜ„Å£„Å¶„Å≠">
      <div class="discount-msg" id="discount-msg"></div>
    </div>
    <div style="margin-top:8px">
      <button class="btn btn-green" onclick="Game.shopToNext()">„Å§„Åé„ÅÆ „Çπ„ÉÜ„Éº„Ç∏„Å∏ ‚Üí</button>
      <button class="btn btn-small" onclick="Game.backToTitle()">„Çø„Ç§„Éà„É´„Å∏</button>
    </div>
  </div>
</div>

<!-- GAME OVER -->
<div id="gameover-screen" class="screen">
  <div class="panel" style="max-width:410px">
    <div class="gameover-title">GAME OVER</div>
    <div class="gameover-sub">„ÇÜ„ÅÜ„Åó„ÇÉ„ÅØ „Åü„Åä„Çå„Åü...</div>
    <div class="result-grid" id="gameover-results"></div>
    <button class="btn btn-green" onclick="Game.retryBattle()">„ÇÇ„ÅÜ „ÅÑ„Å°„Å©</button>
    <button class="btn btn-small" onclick="Game.openShopFromGameover()">üè™ „Ç∑„Éß„ÉÉ„Éó„Å∏</button>
    <button class="btn btn-small" onclick="Game.backToTitle()">„Çø„Ç§„Éà„É´„Å∏</button>
  </div>
</div>
<!-- FREE TYPING -->
<div id="free-screen" class="screen">
  <div class="panel" style="max-width:460px">
    <h2>„Åò„ÇÜ„ÅÜ„Çå„Çì„Åó„ÇÖ„ÅÜ</h2>
    <p style="font-size:8px;color:#707070;margin-bottom:8px">„Åô„Åç„Å™ „Å∂„Çì„Åó„Çá„ÅÜ„Çí „ÅÜ„Å£„Å¶„Åø„Çà„ÅÜ</p>
    <textarea id="free-input" class="free-input" placeholder="„Åì„Åì„Å´ „ÅÜ„Å£„Å¶„Åø„Çà„ÅÜ..."></textarea>
    <div class="free-stats"><span>„ÇÇ„Åò: <span id="free-chars">0</span></span><span>„Åü„Çì„Åî: <span id="free-words">0</span></span></div>
    <button class="btn btn-small" style="margin-top:8px" onclick="Game.showScreen('title-screen')">„ÇÇ„Å©„Çã</button>
  </div>
</div>

<!-- RANKING -->
<div id="ranking-screen" class="screen">
  <div class="panel" style="max-width:460px">
    <h2>RANKING</h2>
    <div class="ranking-list" id="ranking-list"></div>
    <button class="btn btn-small" style="margin-top:10px" onclick="Game.showScreen('title-screen')">„ÇÇ„Å©„Çã</button>
  </div>
</div>

<script>
const isMobile='ontouchstart'in window||navigator.maxTouchPoints>0;
if(isMobile)document.body.classList.add('is-mobile');

/* ===== 8x8 PIXEL ICONS ===== */
const ICONS={
  sword:{c:['','#d8d8d0','#a0a098','#805030','#d0a820','#505050'],d:['00000010','00000120','00001200','04012000','00420000','04040000','40000000','00000000']},
  swords:{c:['','#d8d8d0','#a0a098','#805030','#d0a820','#484848'],d:['1000000100','0120001200','0012012000','0001210000','0001210000','0012012000','0120001200','1000000100'],w:10},
  fire:{c:['','#d03030','#d07020','#d0a820','#f0d840'],d:['00030000','00340000','03443000','03443000','13431000','13331000','01331000','00110000']},
  star:{c:['','#d0a820','#f0d840','#a08018'],d:['00010000','00010000','01121000','00111000','01121000','11000110','10000010','00000000']},
  sword_sm:{c:['','#d8d8d0','#a0a098','#805030','#d0a820'],d:['00000010','00000100','00041000','00400000','04000000','00000000','00000000','00000000']},
  trophy:{c:['','#d0a820','#f0d840','#a08018','#805030'],d:['11111110','12222210','12222210','01222100','00121000','00010000','00111000','01111100']},
  scroll:{c:['','#d8d8d0','#b0b0a8','#808078','#d0a820'],d:['01111100','14444410','10000010','10000010','10000010','10000010','14444410','01111100']},
  person:{c:['','#d0a820','#d8d8d0','#3060c0','#805030'],d:['00110000','00110000','01221000','00110000','00110000','01001000','01001000','01001000']},
  heart:{c:['','#d03030','#f05050','#a02020'],d:['01001000','11211100','12222210','12222210','01222100','00121000','00010000','00000000']},
};

function drawIcon(cv,key){
  const ic=ICONS[key];if(!ic)return;
  const c=cv.getContext('2d');
  const w=ic.w||8,h=ic.d.length;
  cv.width=w;cv.height=h;
  c.clearRect(0,0,w,h);
  for(let y=0;y<h;y++)for(let x=0;x<(ic.d[y]||'').length;x++){
    const i=parseInt(ic.d[y][x]);
    if(i>0&&ic.c[i]){c.fillStyle=ic.c[i];c.fillRect(x,y,1,1)}
  }
}

function initIcons(){
  document.querySelectorAll('[data-icon]').forEach(cv=>{
    drawIcon(cv,cv.dataset.icon);
  });
  // Title icon (crossed swords)
  const ti=document.getElementById('title-icon');
  if(ti){drawIcon(ti,'swords');ti.style.width='64px';ti.style.height='52px'}
}

/* ===== PIXEL BACKGROUND ===== */
const bgC=document.getElementById('bg'),bgX=bgC.getContext('2d');
const COL={s1:'#101848',s2:'#183070',s3:'#2848a0',s4:'#4870c0',s5:'#78a8d8',g1:'#30a030',g2:'#28882a',g3:'#209020',g4:'#38b838',d1:'#886820',d2:'#785818',d3:'#987830',d4:'#685010',st1:'#686868',st2:'#585858',star:'#f0f0d0'};
const bstars=[];for(let i=0;i<60;i++)bstars.push({x:Math.random(),y:Math.random()*.45,s:Math.random()<.3?2:1,b:Math.random()});
function drawBG(){
  const vw=Math.ceil(window.innerWidth/4),vh=Math.ceil(window.innerHeight/4);
  bgC.width=vw;bgC.height=vh;bgC.style.width=window.innerWidth+'px';bgC.style.height=window.innerHeight+'px';
  const g=bgX;
  [[0,.15,COL.s1],[.15,.25,COL.s2],[.25,.35,COL.s3],[.35,.45,COL.s4],[.45,.5,COL.s5]].forEach(([s,e,c])=>{g.fillStyle=c;g.fillRect(0,Math.floor(s*vh),vw,Math.ceil((e-s)*vh)+1)});
  bstars.forEach(s=>{g.globalAlpha=Math.sin(Date.now()*.001+s.b*100)*.3+.7*(.5+s.b*.5);g.fillStyle=COL.star;g.fillRect(Math.floor(s.x*vw),Math.floor(s.y*vh),s.s,s.s)});
  g.globalAlpha=1;
  const gy=Math.floor(vh*.5);
  for(let x=0;x<vw;x+=2){g.fillStyle=[COL.g1,COL.g2,COL.g3,COL.g4][Math.floor(Math.random()*4)];g.fillRect(x,gy,2,4)}
  for(let y=gy+4;y<vh;y+=2)for(let x=0;x<vw;x+=2){g.fillStyle=[COL.d1,COL.d2,COL.d3,COL.d4][Math.floor(Math.random()*4)];g.fillRect(x,y,2,2)}
  for(let i=0;i<15;i++){g.fillStyle=Math.random()<.5?COL.st1:COL.st2;g.fillRect(Math.floor(Math.random()*vw/2)*2,gy+4+Math.floor(Math.random()*(vh-gy-4)/2)*2,2,2)}
}
drawBG();window.addEventListener('resize',drawBG);setInterval(drawBG,2500);

/* ===== PARTICLES ===== */
const fxC=document.getElementById('fx'),fxX=fxC.getContext('2d');let parts=[];
function rFX(){fxC.width=Math.ceil(window.innerWidth/3);fxC.height=Math.ceil(window.innerHeight/3);fxC.style.width=window.innerWidth+'px';fxC.style.height=window.innerHeight+'px'}
window.addEventListener('resize',rFX);rFX();
function spawnP(x,y,c,n=5){const sx=x/3,sy=y/3;for(let i=0;i<n;i++)parts.push({x:sx,y:sy,vx:(Math.random()-.5)*4,vy:(Math.random()-.5)*4-1.5,life:1,c,s:Math.random()*2+1})}
function spawnBoom(x,y){const cs=['#d0a820','#d03030','#30d030','#3060c0','#a030d0'];const sx=x/3,sy=y/3;for(let i=0;i<18;i++){const a=Math.random()*6.28,s=Math.random()*5+1.5;parts.push({x:sx,y:sy,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,c:cs[i%cs.length],s:Math.random()*3+2})}}
function tickFX(){fxX.clearRect(0,0,fxC.width,fxC.height);parts=parts.filter(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=.1;p.life-=.03;if(p.life<=0)return false;fxX.globalAlpha=p.life;fxX.fillStyle=p.c;fxX.fillRect(Math.floor(p.x),Math.floor(p.y),Math.ceil(p.s),Math.ceil(p.s));return true});fxX.globalAlpha=1;requestAnimationFrame(tickFX)}
tickFX();

/* ===== PIXEL MONSTERS ===== */
const PM={
  slime:{c:['','#30a030','#209020','#186818','#50c050','#101010'],d:['0000000000000000','0000011110000000','0001122211000000','0012244224100000','0122452245210000','1224222224221000','1222222222221000','1222233233221000','0122222222210000','0012222222100000','0001222221000000','0000111110000000','0000000000000000','0000000000000000','0000000000000000','0000000000000000']},
  bat:{c:['','#5028a0','#381870','#7040c0','#d03030','#101010'],d:['0000000000000000','0100000000001000','1110000000011100','1161000000161100','0116100001611000','0011611116110000','0001113311100000','0000114411000000','0000113311000000','0000011110000000','0000001100000000','0000000000000000','0000000000000000','0000000000000000','0000000000000000','0000000000000000']},
  skeleton:{c:['','#d8d8d0','#b0b0a8','#808078','#383838','#d03030'],d:['0000011100000000','0001111110000000','0011155110000000','0011211210000000','0001111110000000','0000131300000000','0001111100000000','0010111010000000','0100111001000000','0001111100000000','0000111000000000','0000131000000000','0000111000000000','0001000100000000','0011000110000000','0000000000000000']},
  zombie:{c:['','#50a050','#408040','#306030','#805030','#d03030','#101010','#d8d8d0'],d:['0000444400000000','0004444440000000','0011111110000000','0012112110000000','0015115110000000','0011111110000000','0011777110000000','0001111100000000','0003113000000000','0031111300000000','1111111111000000','0001111000000000','0001001000000000','0003003000000000','0003003000000000','0000000000000000']},
  dragon:{c:['','#d03030','#a02020','#701818','#d0a820','#d07020','#101010','#f06040'],d:['0010000000100000','0110000001100000','1112111121100000','0122222222100000','0122422421100000','0122522521100000','0012222221000000','0001244410000000','0011111111001000','1011111111011000','0011111111001000','0011111110000000','0010110101000000','0030330303000000','0000000000000000','0000000000000000']},
  boss:{c:['','#a030d0','#8020b0','#501880','#d0a820','#d03030','#101010','#e070e0','#301060'],d:['0040000000040000','0441000000144000','0014411114410000','0011111111110000','0012172271210000','0012152251210000','0011111111110000','0011444441110000','0001111111000000','0041111111040000','0401111111040000','0041111111040000','0001111111000000','0001100110000000','0003300330000000','0000000000000000']},
  goblin:{c:['','#40a040','#308030','#206020','#d0a820','#101010','#c02020'],d:['0000000000000000','0000011100000000','0001111110000000','0101155110100000','0011151510000000','0011111110000000','0001166100000000','0000111000000000','0000232000000000','0001222100000000','0000111000000000','0000101000000000','0000303000000000','0000000000000000','0000000000000000','0000000000000000']},
  ghost:{c:['','#e0e0f0','#c0c0d8','#a0a0b8','#4040a0','#101010'],d:['0000011100000000','0001111110000000','0011111111000000','0011141111000000','0011151111000000','0011111111000000','0011111111000000','0011111111000000','0011111111000000','0021111121000000','0012111211000000','0101010101000000','0000000000000000','0000000000000000','0000000000000000','0000000000000000']},
  mushroom:{c:['','#d03030','#e05050','#f0f0d0','#c0a070','#a08050','#101010'],d:['0000111100000000','0001311310000000','0013111131000000','0111311131100000','1111111111100000','0111111111000000','0001111100000000','0000444000000000','0000464000000000','0000444000000000','0000464000000000','0000444000000000','0000555000000000','0000000000000000','0000000000000000','0000000000000000']},
  wolf:{c:['','#a0a0a8','#808088','#606068','#3040a0','#101010','#d03030'],d:['0000000000000000','0001000010000000','0011100011100000','0011111111100000','0011141411100000','0011151511100000','0001111111000000','0000116110000000','0001111110000000','0001111110000000','0001111110000000','0001111110000000','0001010100000000','0003030300000000','0000000000000000','0000000000000000']},
  golem:{c:['','#808088','#606068','#404048','#d0a820','#a0a0a0'],d:['0000111100000000','0001111110000000','0011111111000000','0011141411000000','0011111111000000','0001111110000000','0011111111000000','0111111111100000','1111111111110000','0111111111100000','0011111111000000','0011111111000000','0011100111000000','0011100111000000','0000000000000000','0000000000000000']},
  scorpion:{c:['','#c03020','#a02818','#701810','#d0a820','#101010'],d:['0000000001000000','0000000010100000','0000000101000000','0000001110000000','0011111100000000','0111111110000000','0111141110000000','0111111110000000','0111111110000000','0011111100000000','1001101001000000','1001101001000000','0000000000000000','0000000000000000','0000000000000000','0000000000000000']},
  wizard:{c:['','#7030b0','#5020a0','#381880','#d0a820','#d8c8b0','#101010','#3060c0'],d:['0000010000000000','0000111000000000','0001111100000000','0001414100000000','0000555000000000','0000565000000000','0000555000000000','0001111100000000','0011111110000000','0011711110000000','0011111110000000','0001111100000000','0000111000000000','0000101000000000','0000000000000000','0000000000000000']},
};
function drawMon(cv,key){const m=PM[key];if(!m)return;const c=cv.getContext('2d');c.clearRect(0,0,16,16);for(let y=0;y<16;y++)for(let x=0;x<16;x++){const i=parseInt(m.d[y][x]);if(i>0&&m.c[i]){c.fillStyle=m.c[i];c.fillRect(x,y,1,1)}}}

/* ===== AUDIO ===== */
const AC=window.AudioContext||window.webkitAudioContext;let ac;
function initA(){if(!ac)ac=new AC();ac.resume()}
function snd(f,d=.07,t='square'){if(!ac)return;const o=ac.createOscillator(),g=ac.createGain();o.connect(g);g.connect(ac.destination);o.type=t;o.frequency.value=f;g.gain.setValueAtTime(.1,ac.currentTime);g.gain.exponentialRampToValueAtTime(.001,ac.currentTime+d);o.start();o.stop(ac.currentTime+d)}
function sfxType(){snd(660,.03)}function sfxOk(){snd(523,.07);setTimeout(()=>snd(784,.07),50)}function sfxBad(){snd(160,.12,'sawtooth')}function sfxLvl(){[523,659,784,1047].forEach((f,i)=>setTimeout(()=>snd(f,.1,'triangle'),i*70))}function sfxKill(){[784,988,1175,1319].forEach((f,i)=>setTimeout(()=>snd(f,.12,'triangle'),i*50))}

/* ===== SPECIAL MOVES ===== */
const SKILLS=[
  {combo:5,name:'„Éï„Ç°„Ç§„Ç¢„Çπ„É©„ÉÉ„Ç∑„É•',color:'#f06030',mult:2,notes:[523,659,784,1047,1319],pc:['#f06030','#f0a020','#f0d040']},
  {combo:10,name:'„Çµ„É≥„ÉÄ„Éº„Çπ„Éà„Éº„É†',color:'#40c0f0',mult:3,notes:[659,784,988,1175,1397],pc:['#40c0f0','#80e0ff','#f0f070']},
  {combo:15,name:'„É°„ÉÜ„Ç™„Çπ„Éà„É©„Ç§„ÇØ',color:'#d030d0',mult:5,notes:[784,988,1175,1319,1568],pc:['#d030d0','#f060f0','#f0a040','#d03030']},
  {combo:20,name:'„ÇÆ„Ç¨„Éñ„É¨„Ç§„ÇØ',color:'#d0a820',mult:10,notes:[523,659,784,988,1175,1319,1568],pc:['#d0a820','#f0d040','#d03030','#30d030','#40c0f0','#d030d0']},
];
function sfxSkill(sk){sk.notes.forEach((f,i)=>setTimeout(()=>snd(f,.15,'triangle'),i*80))}
function sfxHit(){snd(120,.15,'sawtooth');setTimeout(()=>snd(90,.1,'sawtooth'),60)}

/* ===== ATTACK CONFIG (per stage: time=seconds to charge, dmg=damage per hit) ===== */
const ATK_CFG=[{time:15,dmg:8},{time:12,dmg:12},{time:10,dmg:16},{time:8,dmg:22},{time:6,dmg:30}];

function sfxBuy(){[523,659,784,1047].forEach((f,i)=>setTimeout(()=>snd(f,.08,'triangle'),i*50))}
function sfxPotion(){snd(784,.1,'triangle');setTimeout(()=>snd(1047,.08,'triangle'),80)}
function sfxInn(){[392,523,659,784,659,784,1047].forEach((f,i)=>setTimeout(()=>snd(f,.12,'triangle'),i*100))}

/* ===== SHOP DATA ===== */
const SHOP_WEAPONS=[
  {id:'w1',name:'„Åç„ÅÆ„Åº„ÅÜ',desc:'„Åì„ÅÜ„Åí„Åç+2',atk:2,cost:50},
  {id:'w2',name:'„Å¶„Å§„ÅÆ„Åë„Çì',desc:'„Åì„ÅÜ„Åí„Åç+5',atk:5,cost:120},
  {id:'w3',name:'„ÅØ„Åå„Å≠„ÅÆ„Åë„Çì',desc:'„Åì„ÅÜ„Åí„Åç+8',atk:8,cost:280},
  {id:'w4',name:'„Åæ„Åª„ÅÜ„ÅÆ„Åë„Çì',desc:'„Åì„ÅÜ„Åí„Åç+12',atk:12,cost:500},
  {id:'w5',name:'„Åß„Çì„Åõ„Å§„ÅÆ„Åë„Çì',desc:'„Åì„ÅÜ„Åí„Åç+18',atk:18,cost:1000},
];
const SHOP_ITEMS=[
  {id:'i1',name:'„ÇÑ„Åè„Åù„ÅÜ',desc:'HP+30',heal:30,cost:15},
  {id:'i2',name:'„Åã„ÅÑ„Åµ„Åè„ÇÑ„Åè',desc:'HP+80',heal:80,cost:40},
  {id:'i3',name:'„Åæ„Çì„Åü„Çì„ÇÑ„Åè',desc:'HP„Åú„Çì„Åã„ÅÑ„Åµ„Åè',heal:9999,cost:100},
];
const INN_COST=25;

/* ===== WORDS ===== */
const WPC={1:['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'],2:['a','i','u','e','o','ka','ki','ku','ke','ko','sa','si','su','se','so','ta','ti','tu','te','to','na','ni','nu','ne','no','ha','hi','hu','he','ho','ma','mi','mu','me','mo','ya','yu','yo','ra','ri','ru','re','ro','wa','nn'],3:['neko','inu','sora','umi','yama','hana','kaze','tsuki','hoshi','kumo','ame','yuki','tori','sakana','mizu','mori','kawa','machi','sakura','ringo','sensei','gakkou','origami','karate','samurai','tanuki','usagi','kuma','kirin','zou','raion','penguin','iruka','kujira','tobira','densha','hikari','kagami','tokei','kutsu','hon','enpitsu','keshigomu','randoseru','taiko','piano','chikyuu','uchuu','rocket','dinosaur','volcano','crystal','rainbow','thunder'],4:['sora ha aoi','umi ha hiroi','hana ga saku','kaze ga fuku','ame ga furu','tori ga utau','neko ga warau','inu ga hashiru','ohayou gozaimasu','konnichiha','arigatou','gomen nasai','itadakimasu','gochisousama','okaeri nasai','oyasumi nasai','ganbatte ne','tanoshii na','oishii gohan','genki desu ka','ashita mo ganbarou','kyou ha ii hi da','mizu wo nomo u','soto de asobou','hayaku hashirou','ookiku naritai','yume wo mite iru','himitsu no basho','chiisana bouken','niji ga mieru','hoshi ga kirei','kaze ga kimochi ii','taiyou ga noboru','asa gohan tabeta','homework owaranai','suugaku ga suki','taiiku ga tanoshii','toshokan de yomu','puuru de oyogu','doubutsuen ni ikou'],5:['kyou ha totemo ii tenki desu','ashita ha gakkou ga yasumi desu','watashi ha ringo ga suki desu','ookina ki no shita de asobou','umi de oyogu no ha tanoshii','yama ni nobotte keshiki wo miyou','tomodachi to issho ni asobou','sekai ha fushigi de ippai da','yuuki wo motte bouken shiyou','donna toki mo egao wo wasurenai','hayaoki ha sanmon no toku','nana korobi ya oki','saru mo ki kara ochiru','ame futte ji katamaru','isogaba maware','chiri mo tsumoreba yama to naru','ichi nichi issho no egao wo','minna de chikara wo awaseyou','shiranai koto wo manabu no ha tanoshii','mirai ha jibun de tsukuru mono da']};
const WMB={1:WPC[1],2:['„ÅÇ','„ÅÑ','„ÅÜ','„Åà','„Åä','„Åã','„Åç','„Åè','„Åë','„Åì','„Åï','„Åó','„Åô','„Åõ','„Åù','„Åü','„Å°','„Å§','„Å¶','„Å®','„Å™','„Å´','„Å¨','„Å≠','„ÅÆ','„ÅØ','„Å≤','„Åµ','„Å∏','„Åª','„Åæ','„Åø','„ÇÄ','„ÇÅ','„ÇÇ','„ÇÑ','„ÇÜ','„Çà','„Çâ','„Çä','„Çã','„Çå','„Çç','„Çè','„Çì'],3:['„Å≠„Åì','„ÅÑ„Å¨','„Åù„Çâ','„ÅÜ„Åø','„ÇÑ„Åæ','„ÅØ„Å™','„Åã„Åú','„Å§„Åç','„Åª„Åó','„Åè„ÇÇ','„ÅÇ„ÇÅ','„ÇÜ„Åç','„Å®„Çä','„Åï„Åã„Å™','„Åø„Åö','„ÇÇ„Çä','„Åã„Çè','„Åæ„Å°','„Åï„Åè„Çâ','„Çä„Çì„Åî','„Åõ„Çì„Åõ„ÅÑ','„Åå„Å£„Åì„ÅÜ','„Åä„Çä„Åå„Åø','„Åã„Çâ„Å¶','„Åï„ÇÄ„Çâ„ÅÑ','„Åü„Å¨„Åç','„ÅÜ„Åï„Åé','„Åè„Åæ','„Åç„Çä„Çì','„Åû„ÅÜ','„Çâ„ÅÑ„Åä„Çì','„Å∫„Çì„Åé„Çì','„ÅÑ„Çã„Åã','„Åè„Åò„Çâ','„Å®„Å≥„Çâ','„Åß„Çì„Åó„ÇÉ','„Å≤„Åã„Çä','„Åã„Åå„Åø','„Å®„Åë„ÅÑ','„Åè„Å§','„Åª„Çì','„Åà„Çì„Å¥„Å§','„Åë„Åó„Åî„ÇÄ','„Çâ„Çì„Å©„Åõ„Çã','„Åü„ÅÑ„Åì','„Å¥„ÅÇ„ÅÆ','„Å°„Åç„ÇÖ„ÅÜ','„ÅÜ„Å°„ÇÖ„ÅÜ','„Çç„Åë„Å£„Å®','„Å´„Åò','„Åã„Åø„Å™„Çä'],4:['„Åù„Çâ„ÅØ„ÅÇ„Åä„ÅÑ','„ÅÜ„Åø„ÅØ„Å≤„Çç„ÅÑ','„ÅØ„Å™„Åå„Åï„Åè','„Åã„Åú„Åå„Åµ„Åè','„ÅÇ„ÇÅ„Åå„Åµ„Çã','„Å®„Çä„Åå„ÅÜ„Åü„ÅÜ','„Å≠„Åì„Åå„Çè„Çâ„ÅÜ','„ÅÑ„Å¨„Åå„ÅØ„Åó„Çã','„Åä„ÅØ„Çà„ÅÜ','„Åì„Çì„Å´„Å°„ÅØ','„ÅÇ„Çä„Åå„Å®„ÅÜ','„Åî„ÇÅ„Çì„Å™„Åï„ÅÑ','„ÅÑ„Åü„Å†„Åç„Åæ„Åô','„Åî„Å°„Åù„ÅÜ„Åï„Åæ','„Åä„Åã„Åà„Çä„Å™„Åï„ÅÑ','„Åä„ÇÑ„Åô„Åø„Å™„Åï„ÅÑ','„Åå„Çì„Å∞„Å£„Å¶„Å≠','„Åü„ÅÆ„Åó„ÅÑ„Å™','„Åä„ÅÑ„Åó„ÅÑ„Åî„ÅØ„Çì','„Åí„Çì„Åç„Åß„Åô„Åã','„ÅÇ„Åó„Åü„ÇÇ„Åå„Çì„Å∞„Çç„ÅÜ','„Åç„Çá„ÅÜ„ÅØ„ÅÑ„ÅÑ„Å≤„Å†','„Åø„Åö„Çí„ÅÆ„ÇÇ„ÅÜ','„Åù„Å®„Åß„ÅÇ„Åù„Åº„ÅÜ','„ÅØ„ÇÑ„Åè„ÅØ„Åó„Çç„ÅÜ','„Åä„Åä„Åç„Åè„Å™„Çä„Åü„ÅÑ','„ÇÜ„ÇÅ„Çí„Åø„Å¶„ÅÑ„Çã','„Å≤„Åø„Å§„ÅÆ„Å∞„Åó„Çá','„Å°„ÅÑ„Åï„Å™„Åº„ÅÜ„Åë„Çì','„Å´„Åò„Åå„Åø„Åà„Çã','„Åª„Åó„Åå„Åç„Çå„ÅÑ','„Åã„Åú„Åå„Åç„ÇÇ„Å°„ÅÑ„ÅÑ','„Åü„ÅÑ„Çà„ÅÜ„Åå„ÅÆ„Åº„Çã','„ÅÇ„Åï„Åî„ÅØ„Çì„Åü„Åπ„Åü','„Åó„ÇÖ„Åè„Å†„ÅÑ„Åä„Çè„Çâ„Å™„ÅÑ','„Åï„Çì„Åô„ÅÜ„Åå„Åô„Åç','„Åü„ÅÑ„ÅÑ„Åè„Åå„Åü„ÅÆ„Åó„ÅÑ','„Å®„Åó„Çá„Åã„Çì„Åß„Çà„ÇÄ','„Å∑„Éº„Çã„Åß„Åä„Çà„Åê','„Å©„ÅÜ„Å∂„Å§„Åà„Çì„Å´„ÅÑ„Åì„ÅÜ'],5:['„Åç„Çá„ÅÜ„ÅØ„Å®„Å¶„ÇÇ„ÅÑ„ÅÑ„Å¶„Çì„Åç„Åß„Åô','„ÅÇ„Åó„Åü„ÅØ„Åå„Å£„Åì„ÅÜ„Åå„ÇÑ„Åô„Åø„Åß„Åô','„Çè„Åü„Åó„ÅØ„Çä„Çì„Åî„Åå„Åô„Åç„Åß„Åô','„Åä„Åä„Åç„Å™„Åç„ÅÆ„Åó„Åü„Åß„ÅÇ„Åù„Åº„ÅÜ','„ÅÜ„Åø„Åß„Åä„Çà„Åê„ÅÆ„ÅØ„Åü„ÅÆ„Åó„ÅÑ','„ÇÑ„Åæ„Å´„ÅÆ„Åº„Å£„Å¶„Åë„Åó„Åç„Çí„Åø„Çà„ÅÜ','„Å®„ÇÇ„Å†„Å°„Å®„ÅÑ„Å£„Åó„Çá„Å´„ÅÇ„Åù„Åº„ÅÜ','„Åõ„Åã„ÅÑ„ÅØ„Åµ„Åó„Åé„Åß„ÅÑ„Å£„Å±„ÅÑ„Å†','„ÇÜ„ÅÜ„Åç„Çí„ÇÇ„Å£„Å¶„Åº„ÅÜ„Åë„Çì„Åó„Çà„ÅÜ','„Å©„Çì„Å™„Å®„Åç„ÇÇ„Åà„Åå„Åä„Çí„Çè„Åô„Çå„Å™„ÅÑ','„ÅØ„ÇÑ„Åä„Åç„ÅØ„Åï„Çì„ÇÇ„Çì„ÅÆ„Å®„Åè','„Å™„Å™„Åì„Çç„Å≥„ÇÑ„Åä„Åç','„Åï„Çã„ÇÇ„Åç„Åã„Çâ„Åä„Å°„Çã','„ÅÇ„ÇÅ„Åµ„Å£„Å¶„Åò„Åã„Åü„Åæ„Çã','„ÅÑ„Åù„Åå„Å∞„Åæ„Çè„Çå','„Å°„Çä„ÇÇ„Å§„ÇÇ„Çå„Å∞„ÇÑ„Åæ„Å®„Å™„Çã','„ÅÑ„Å°„Å´„Å°„ÅÑ„Å£„Åó„Çá„ÅÜ„ÅÆ„Åà„Åå„Åä„Çí','„Åø„Çì„Å™„Åß„Å°„Åã„Çâ„Çí„ÅÇ„Çè„Åõ„Çà„ÅÜ','„Åó„Çâ„Å™„ÅÑ„Åì„Å®„Çí„Åæ„Å™„Å∂„ÅÆ„ÅØ„Åü„ÅÆ„Åó„ÅÑ','„Åø„Çâ„ÅÑ„ÅØ„Åò„Å∂„Çì„Åß„Å§„Åè„Çã„ÇÇ„ÅÆ„Å†']};
const SD_PC=['„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„Éà 1„ÇÇ„Åò','„Å≤„Çâ„Åå„Å™ > „É≠„Éº„Éû„Åò','„Åü„Çì„Åî > „É≠„Éº„Éû„Åò','„Å´„Åª„Çì„Åî „Éï„É¨„Éº„Ç∫','„Å´„Åª„Çì„Åî „Å°„Çá„ÅÜ„Å∂„Çì'];
const SD_MB=['„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„Éà 1„ÇÇ„Åò','„Å≤„Çâ„Åå„Å™ 1„ÇÇ„Åò','„Å´„Åª„Çì„Åî „Åü„Çì„Åî','„Å´„Åª„Çì„Åî „Éï„É¨„Éº„Ç∫','„Å´„Åª„Çì„Åî „Å°„Çá„ÅÜ„Å∂„Çì'];
function getW(s){return WMB[Math.min(s,5)]}
function getD(s){return SD_MB[Math.min(s,5)-1]}

const MONS=[[{name:'„Çπ„É©„Ç§„É†',key:'slime',hp:15,xp:12},{name:'„Åç„ÅÆ„Åì',key:'mushroom',hp:18,xp:14}],[{name:'„Ç¥„Éñ„É™„É≥',key:'goblin',hp:28,xp:20},{name:'„Ç≥„Ç¶„É¢„É™',key:'bat',hp:30,xp:22},{name:'„Çπ„É©„Ç§„É†',key:'slime',hp:22,xp:16}],[{name:'„Ç¶„É´„Éï',key:'wolf',hp:45,xp:35},{name:'„Çπ„Ç±„É´„Éà„É≥',key:'skeleton',hp:55,xp:40},{name:'„Ç¥„Éº„Çπ„Éà',key:'ghost',hp:40,xp:32},{name:'„Ç¥„Éñ„É™„É≥',key:'goblin',hp:38,xp:28}],[{name:'„Çæ„É≥„Éì',key:'zombie',hp:75,xp:55},{name:'„Çµ„ÇΩ„É™',key:'scorpion',hp:85,xp:60},{name:'„Ç¥„Éº„É¨„É†',key:'golem',hp:100,xp:70},{name:'„Éâ„É©„Ç¥„É≥',key:'dragon',hp:110,xp:85}],[{name:'„Éâ„É©„Ç¥„É≥',key:'dragon',hp:160,xp:120},{name:'„Åæ„Åª„ÅÜ„Å§„Åã„ÅÑ',key:'wizard',hp:140,xp:110},{name:'„Åæ„Åä„ÅÜ',key:'boss',hp:280,xp:220}]];

/* ===== KEYBOARD ===== */
const KBR=[['Q','W','E','R','T','Y','U','I','O','P'],['A','S','D','F','G','H','J','K','L'],['Z','X','C','V','B','N','M']];
function buildKB(){const kb=document.getElementById('keyboard');kb.innerHTML='';KBR.forEach((row,ri)=>{const r=document.createElement('div');r.className='kb-row';if(ri===2){const bs=document.createElement('div');bs.className='kb-key wide';bs.textContent='BS';bs.id='kb-BS';r.appendChild(bs)}row.forEach(k=>{const d=document.createElement('div');d.className='kb-key';d.textContent=k;d.id='kb-'+k;r.appendChild(d)});kb.appendChild(r)});const sr=document.createElement('div');sr.className='kb-row';const sp=document.createElement('div');sp.className='kb-key space';sp.textContent='SPACE';sp.id='kb-SP';sr.appendChild(sp);kb.appendChild(sr)}
function hlKey(c){const id=c==='Backspace'?'kb-BS':'kb-'+c.toUpperCase();const el=document.getElementById(id);if(el){el.classList.add('active');setTimeout(()=>el.classList.remove('active'),120)}}
function showNext(c){document.querySelectorAll('.kb-key').forEach(k=>k.classList.remove('next-key'));if(!c)return;const id=c===' '?'kb-SP':'kb-'+c.toUpperCase();const el=document.getElementById(id);if(el)el.classList.add('next-key')}

/* ===== GAME ===== */
const mI=document.getElementById('mobile-input');
const Game={
  p:{name:'',level:1,xp:0,xpN:60,wt:0,bW:0,bS:0,tc:0,gold:0,atk:0,weapon:'',items:{}},
  stage:1,mon:null,mHp:0,mMax:0,mD:0,pHp:100,pMaxHp:100,atkT:0,atkMax:20,atkDmg:5,atkInt:null,
  word:'',chars:[],cur:0,hasErr:false,
  streak:0,wS:0,sS:0,sW:0,sC:0,sE:0,wIS:0,wPS:10,mBuf:'',composing:false,mOffset:0,wBag:[],wBagS:0,
  stageGold:0,shopBuying:null,shopTypingStart:0,

  init(){try{
    this.load();document.getElementById('player-name').value=this.p.name;
    buildKB();this.updateV();initIcons();
    document.getElementById('player-name').addEventListener('keydown',e=>{if(e.key==='Enter')this.startAdventure()});
    document.getElementById('free-input').addEventListener('input',function(){document.getElementById('free-chars').textContent=this.value.length;document.getElementById('free-words').textContent=this.value.trim()?this.value.trim().split(/\s+/).length:0});
    document.addEventListener('keydown',e=>{if(document.querySelector('#battle-screen.active')&&this.stage<=1){e.preventDefault();this.handleKeyPC(e)}});
    if(isMobile){const pnl=document.querySelector('#battle-screen .panel');const hnt=document.getElementById('typing-hint');pnl.insertBefore(mI,hnt);mI.placeholder='„Åì„Åì„Å´ „ÅÜ„Å£„Å¶„Å≠';mI.addEventListener('blur',()=>{if(document.querySelector('#battle-screen.active'))setTimeout(()=>mI.focus(),10)});mI.addEventListener('compositionstart',()=>{this.composing=true});mI.addEventListener('compositionupdate',()=>{this.updateMD()});mI.addEventListener('compositionend',()=>{this.composing=false;this.updateMD();this.checkMC()});mI.addEventListener('input',e=>{this.updateMD();if(!this.composing&&!e.isComposing)this.checkMC()});window.addEventListener('scroll',()=>{if(document.querySelector('#battle-screen.active'))window.scrollTo(0,0)});if(window.visualViewport){const vv=window.visualViewport;const onR=()=>{const vvOT=vv.offsetTop;document.documentElement.style.setProperty('--vh',vv.height+'px');document.documentElement.style.setProperty('--vv-top',vvOT+'px');const kbH=window.innerHeight-vv.height;const bs=document.getElementById('battle-screen');if(kbH>100){bs&&bs.classList.add('kb-open')}else{bs&&bs.classList.remove('kb-open');document.documentElement.style.setProperty('--vv-top','0px')};window.scrollTo(0,0)};vv.addEventListener('resize',onR);vv.addEventListener('scroll',onR);onR()}
    mI.addEventListener('focus',()=>{setTimeout(()=>window.scrollTo(0,0),50);setTimeout(()=>window.scrollTo(0,0),150);setTimeout(()=>window.scrollTo(0,0),300)})}
    if(!isMobile){const pnl=document.querySelector('#battle-screen .panel');const hnt=document.getElementById('typing-hint');pnl.insertBefore(mI,hnt);mI.style.display='none';mI.placeholder='„Åì„Åì„Å´ „ÅÜ„Å£„Å¶„Å≠';mI.addEventListener('compositionstart',()=>{this.composing=true});mI.addEventListener('compositionend',()=>{this.composing=false;this.updateMD();this.checkMC()});mI.addEventListener('input',e=>{if(!this.composing&&!e.isComposing){this.updateMD();this.checkMC()}})}
    this.updateTitleBtns();
  }catch(e){alert('Init error: '+e.message);console.error(e)}},

  focusInput(){const s=this.stage;if(s===1){mI.setAttribute('inputmode','latin');mI.setAttribute('lang','en');if(!isMobile){mI.classList.remove('pc-ime');mI.style.display='none';document.getElementById('keyboard').style.display=''}}else{mI.removeAttribute('inputmode');mI.setAttribute('lang','ja');if(!isMobile){mI.classList.add('pc-ime');mI.style.display='';document.getElementById('keyboard').style.display='none'}}this.mDL=0;mI.value='';this.mOffset=0;mI.focus()},

  showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');if(id==='ranking-screen')this.renderR();if(id==='free-screen')setTimeout(()=>document.getElementById('free-input').focus(),50)},

  startAdventure(){try{initA();this.p.name=document.getElementById('player-name').value.trim()||'„ÇÜ„ÅÜ„Åó„ÇÉ';if(!this.p.items)this.p.items={};this.stage=this.p.level<=2?1:this.p.level<=4?2:this.p.level<=7?3:this.p.level<=10?4:5;this.sS=Date.now();this.sW=0;this.sC=0;this.sE=0;this.wIS=0;this.streak=0;this.mD=0;this.stageGold=0;this.pMaxHp=80+this.p.level*10;this.pHp=this.pMaxHp;mI.value='';this.mOffset=0;this.spawnM();this.showScreen('battle-screen');this.updateS();this.updatePHP();this.startAtkTimer();setTimeout(()=>this.focusInput(),200)}catch(e){alert('Error: '+e.message);console.error(e)}},

  backToTitle(){this.stopAtkTimer();this.save();this.updateTitleBtns();this.showScreen('title-screen')},

  spawnM(){const pool=MONS[Math.min(this.stage,5)-1];const base=pool[Math.floor(Math.random()*pool.length)];const sc=1+(this.p.level-1)*.08;this.mon={...base};this.mMax=Math.floor(base.hp*sc);this.mHp=this.mMax;const cv=document.getElementById('m-canvas');cv.className='mon-canvas';drawMon(cv,base.key);document.getElementById('m-name').textContent=base.name;document.getElementById('m-stage').textContent='STAGE '+this.stage+' - '+this.p.name;document.getElementById('stage-desc').textContent='> '+getD(this.stage);document.getElementById('typing-hint').textContent=isMobile?'„ÅÜ„Åà„ÅÆ „ÇÇ„Åò„Çí „Åù„ÅÆ„Åæ„Åæ „ÅÜ„Å£„Å¶„Å≠':'„Ç≠„Éº„Éú„Éº„Éâ„Åß „ÅÜ„Å°„Åì„ÇÇ„ÅÜ! BS „Åß„Åë„Åõ„Çã„Çà';this.updateHP();const ac=ATK_CFG[Math.min(this.stage,5)-1];this.atkMax=ac.time;this.atkDmg=ac.dmg;this.nextW()},

  nextW(){const wl=getW(this.stage);if(this.wBagS!==this.stage||this.wBag.length===0){this.wBag=[...wl].sort(()=>Math.random()-.5);this.wBagS=this.stage}if(this.wBag.length===0)this.wBag=[...wl].sort(()=>Math.random()-.5);this.word=this.wBag.pop();this.chars=this.word.split('').map(c=>({c,s:'pending'}));this.cur=0;this.hasErr=false;this.wS=Date.now();if(isMobile){this.mDL=0}this.renderW();if(!isMobile)showNext(this.chars[0]?.c);this.resetAtk()},

  renderW(){document.getElementById('word-display').innerHTML=this.chars.map((ch,i)=>{let cls='char '+ch.s;if(i===this.cur&&ch.s!=='correct')cls+=' current';return`<span class="${cls}">${ch.c===' '?'_':ch.c}</span>`}).join('')},

  handleKeyPC(e){if(e.key==='Backspace')return this.handleBS();if(e.key.length!==1||this.cur>=this.chars.length)return;hlKey(e.key);this.processC(e.key)},

  handleMI(e){const val=mI.value;const prev=this.mBuf;if(val.length<prev.length){this.mBuf=val;return}const nc=val.slice(prev.length);this.mBuf=val;for(const ch of nc)if(this.cur<this.chars.length)this.processC(ch)},

  updateMD(){if(!document.querySelector('#battle-screen.active'))return;if(!isMobile&&this.composing)return;const val=mI.value.slice(this.mOffset);const pL=this.mDL||0;for(let i=0;i<this.chars.length;i++){if(i<val.length){this.chars[i].s=val[i]===this.chars[i].c?'correct':'wrong'}else{this.chars[i].s=i===val.length?'current':'pending'}}this.cur=Math.min(val.length,this.chars.length);if(val.length>pL&&val.length<=this.chars.length){const i=val.length-1;if(val[i]===this.chars[i].c){sfxType();spawnP(window.innerWidth/2,window.innerHeight*.5,'#30d030',2)}else sfxBad()}this.mDL=val.length;this.renderW();if(this.composing&&val.length>=this.word.length){clearTimeout(this.mAT);this.mAT=setTimeout(()=>{if(mI.value.slice(this.mOffset).length>=this.word.length){this.composing=false;this.checkMC()}},400)}},

  checkMC(){const val=mI.value.slice(this.mOffset);if(val.length<this.word.length)return;let err=0;for(let i=0;i<this.word.length;i++){if(val[i]!==this.word[i]){this.chars[i].s='wrong';err++}else{this.chars[i].s='correct'}}this.sC+=this.word.length;this.sE+=err;this.hasErr=err>0;this.cur=this.chars.length;this.renderW();this.mOffset+=this.word.length;this.mDL=0;if(this.mOffset>200){mI.value=mI.value.slice(this.mOffset);this.mOffset=0}this.wordDone()},

  handleBS(){if(!isMobile)hlKey('Backspace');for(let i=Math.min(this.cur,this.chars.length)-1;i>=0;i--){if(this.chars[i].s==='wrong'){this.chars[i].s='pending';this.cur=i;for(let j=i+1;j<this.chars.length;j++)if(this.chars[j].s!=='correct')this.chars[j].s='pending';this.hasErr=this.chars.some(c=>c.s==='wrong');this.renderW();if(!isMobile)showNext(this.chars[this.cur]?.c);snd(440,.02);return}}},

  processC(key){this.sC++;const exp=this.chars[this.cur].c;if(key===exp&&!this.hasErr){this.chars[this.cur].s='correct';this.cur++;sfxType();spawnP(window.innerWidth/2,window.innerHeight*.5,'#30d030',3);if(this.cur>=this.chars.length)this.wordDone();else{this.renderW();if(!isMobile)showNext(this.chars[this.cur]?.c);return}}else{this.chars[this.cur].s='wrong';this.hasErr=true;this.cur++;this.sE++;sfxBad();document.querySelector('#battle-screen .panel')?.classList.add('shake');setTimeout(()=>document.querySelector('#battle-screen .panel')?.classList.remove('shake'),150);if(this.cur<this.chars.length&&!isMobile)showNext(this.chars[this.cur]?.c)}this.renderW()},

  wordDone(){this.resetAtk();const el=(Date.now()-this.wS)/1000;const wpm=el>0?Math.round((this.word.length/5)/(el/60)):0;if(wpm>this.p.bW)this.p.bW=wpm;const bad=this.chars.some(c=>c.s==='wrong');if(bad)this.streak=0;else{this.streak++;if(this.streak>this.p.bS)this.p.bS=this.streak}this.p.wt++;this.p.tc+=this.word.length;this.sW++;this.wIS++;const dmg=Math.max(1,Math.floor((this.word.length+this.p.atk)*(1+this.streak*.15)*(bad?.5:1)));this.mHp=Math.max(0,this.mHp-dmg);sfxOk();const cv=document.getElementById('m-canvas');cv.classList.add('hit');setTimeout(()=>cv.classList.remove('hit'),150);spawnP(window.innerWidth/2,window.innerHeight*.25,'#d03030',5);this.updateHP();this.updateCmb(dmg,wpm);this.updateS();const sk=SKILLS.find(s=>this.streak===s.combo);if(sk){this.triggerSkill(sk,dmg)}else if(this.mHp<=0)this.monK();else setTimeout(()=>{this.nextW();this.focusInput()},300)},

  triggerSkill(sk,baseDmg){this.stopAtkTimer();const bonusDmg=Math.floor(baseDmg*(sk.mult-1));sfxSkill(sk);const ov=document.getElementById('skill-overlay');ov.innerHTML='<div class="skill-flash" style="--sk-c:'+sk.color+'"></div><div class="skill-label">„Å≤„Å£„Åï„Å§„Çè„Åñ</div><div class="skill-name" style="--sk-c:'+sk.color+'">'+sk.name+'</div><div class="skill-dmg" id="skill-dmg-live"></div>';ov.classList.remove('active');ov.offsetHeight;ov.classList.add('active');document.body.classList.add('screen-shake');setTimeout(()=>document.body.classList.remove('screen-shake'),400);for(let i=0;i<40;i++){spawnP(Math.random()*window.innerWidth,Math.random()*window.innerHeight*.6,sk.pc[i%sk.pc.length],2)}setTimeout(()=>{this.mHp=Math.max(0,this.mHp-bonusDmg);this.updateHP();const dd=document.getElementById('skill-dmg-live');if(dd)dd.textContent='-'+bonusDmg;spawnBoom(window.innerWidth/2,window.innerHeight*.3);const cv=document.getElementById('m-canvas');cv.classList.add('hit');setTimeout(()=>cv.classList.remove('hit'),150)},600);setTimeout(()=>{ov.classList.remove('active');this.startAtkTimer();if(this.mHp<=0)this.monK();else setTimeout(()=>{this.nextW();this.focusInput()},200)},1400)},

  monK(){sfxKill();this.pHp=Math.min(this.pMaxHp,this.pHp+15);this.updatePHP();document.getElementById('m-canvas').classList.add('dead');spawnBoom(window.innerWidth/2,window.innerHeight*.25);this.mD++;const goldEarn=Math.floor(this.mon.xp*.6+Math.random()*5);this.p.gold+=goldEarn;this.stageGold+=goldEarn;this.updateGold();this.p.xp+=Math.floor(this.mon.xp*(1+this.p.level*.04));setTimeout(()=>{if(this.p.xp>=this.p.xpN)this.lvlUp();else if(this.wIS>=this.wPS)this.stageClear();else{this.spawnM();this.focusInput()}this.updateS()},600)},

  lvlUp(){this.stopAtkTimer();this.p.xp-=this.p.xpN;this.pMaxHp=80+this.p.level*10;this.pHp=Math.min(this.pMaxHp,this.pHp+20);this.p.level++;this.p.xpN=Math.floor(60*Math.pow(1.25,this.p.level-1));sfxLvl();spawnBoom(window.innerWidth/2,window.innerHeight/2);document.getElementById('lu-level').textContent=this.p.level;const rw=['„Å°„Åã„Çâ„Åå „Åø„Å™„Åé„Çã!','„Çø„Ç§„Éî„É≥„Ç∞„Åå „ÅØ„ÇÑ„Åè„Å™„Å£„Åü!','„Å¶„Åç„Åå „Åä„Åù„Çå„Å¶„ÅÑ„Çã!','„Å§„Çà„Åï„Åå „Åæ„Åó„Åü!','„Åß„Çì„Åõ„Å§„Å´ „Å°„Åã„Å•„ÅÑ„Åü!'];document.getElementById('lu-reward').textContent=rw[Math.floor(Math.random()*rw.length)];this.save();this.showScreen('levelup-screen')},

  continueBattle(){if(this.wIS>=this.wPS)this.stageClear();else{this.showScreen('battle-screen');this.spawnM();this.startAtkTimer();setTimeout(()=>this.focusInput(),200)}},

  stageClear(){this.stopAtkTimer();this.pHp=this.pMaxHp;this.updatePHP();const t=Math.floor((Date.now()-this.sS)/1000);const acc=this.sC>0?Math.round(((this.sC-this.sE)/this.sC)*100):100;const wpm=t>0?Math.round((this.sC/5)/(t/60)):0;const bonus=this.stage*15;this.p.gold+=bonus;this.stageGold+=bonus;this.updateGold();document.getElementById('stage-results').innerHTML=`<div class="result-item"><div class="label">„Åü„Åä„Åó„Åü „Å¶„Åç</div><div class="value">${this.mD}</div></div><div class="result-item"><div class="label">„ÅÜ„Å£„Åü „Åì„Å®„Å∞</div><div class="value">${this.sW}</div></div><div class="result-item"><div class="label">„Åõ„ÅÑ„Åã„Åè„Åï</div><div class="value">${acc}%</div></div><div class="result-item"><div class="label">„Åã„Åõ„ÅÑ„Å† „Ç¥„Éº„É´„Éâ</div><div class="value">üí∞${this.stageGold}G</div></div>`;this.saveR(wpm,acc);this.save();this.showScreen('stageclear-screen')},

  nextStage(){this.pHp=this.pMaxHp;this.updatePHP();this.stage=Math.min(this.stage+1,5);this.sS=Date.now();this.sW=0;this.sC=0;this.sE=0;this.wIS=0;this.mD=0;this.stageGold=0;mI.value='';this.mOffset=0;this.showScreen('battle-screen');this.spawnM();this.startAtkTimer();setTimeout(()=>this.focusInput(),200)},

  updateHP(){const p=Math.max(0,(this.mHp/this.mMax)*100);const b=document.getElementById('m-hp');b.style.width=p+'%';b.className='hp-inner'+(p<15?' crit':p<35?' low':'');document.getElementById('m-hp-txt').textContent='HP '+this.mHp+'/'+this.mMax},
  updateCmb(d,w){const el=document.getElementById('combo-text');document.getElementById('s-wpm').textContent=w>0?w+'WPM':'';if(this.streak>=10){el.textContent='** ULTRA x'+this.streak+' -'+d;el.className='combo ultra'}else if(this.streak>=5){el.textContent='* COMBO x'+this.streak+' -'+d;el.className='combo fire'}else if(this.streak>=3){el.textContent=this.streak+'COMBO -'+d;el.className='combo'}else{el.textContent='-'+d+' DAMAGE';el.className='combo'}},
  updateS(){document.getElementById('s-level').textContent=this.p.level;document.getElementById('s-streak').textContent=this.streak;document.getElementById('s-words').textContent=this.p.wt;document.getElementById('s-xp').style.width=Math.min(100,(this.p.xp/this.p.xpN)*100)+'%';this.updateGold();this.updatePotionBtn()},
  updateGold(){const el=document.getElementById('s-gold');if(el)el.textContent='üí∞'+this.p.gold},
  updatePotionBtn(){const btn=document.getElementById('potion-btn');if(!btn)return;const tot=Object.values(this.p.items).reduce((a,b)=>a+b,0);btn.textContent='üíä'+tot;btn.className=tot>0?'potion-btn':'potion-btn empty'},
  usePotion(){const items=this.p.items;const keys=['i1','i2','i3'];let used=null;for(const k of keys){if(items[k]&&items[k]>0){used=k;break}}if(!used)return;const it=[...SHOP_ITEMS].find(i=>i.id===used);if(!it)return;items[used]--;if(items[used]<=0)delete items[used];const heal=it.heal>=9999?this.pMaxHp:it.heal;this.pHp=Math.min(this.pMaxHp,this.pHp+heal);sfxPotion();spawnP(window.innerWidth/2,window.innerHeight*.6,'#30d030',8);this.updatePHP();this.updatePotionBtn();this.save()},

  /* ===== SHOP ===== */
  openShop(){this.stageGold=0;document.getElementById('shop-gold').textContent='üí∞ '+this.p.gold+'G';this.shopBuying=null;document.getElementById('shop-typing-area').classList.remove('active');document.getElementById('discount-msg').textContent='';this.shopTab('inn');this.showScreen('shop-screen')},
  shopTab(tab){document.querySelectorAll('.shop-tab').forEach(t=>t.classList.remove('active'));document.getElementById('tab-'+tab).classList.add('active');this.shopBuying=null;document.getElementById('shop-typing-area').classList.remove('active');document.getElementById('discount-msg').textContent='';const list=document.getElementById('shop-list');if(tab==='inn'){const canAfford=this.p.gold>=INN_COST;const full=this.pHp>=this.pMaxHp;list.innerHTML=`<div class="shop-item${!canAfford?' cant-afford':''}${full?' owned':''}" onclick="Game.shopBuyStart('inn')"><span class="si-name">üè® „ÇÑ„Å©„ÇÑ</span><span class="si-desc">HP„Åú„Çì„Åã„ÅÑ„Åµ„Åè</span><span class="si-cost${!canAfford?' expensive':''}">${INN_COST}G</span></div><div style="font-size:7px;color:#606070;margin:6px 0;text-align:center">HP: ${this.pHp} / ${this.pMaxHp}</div>`}else if(tab==='weapon'){list.innerHTML=SHOP_WEAPONS.map(w=>{const owned=this.p.weapon===w.id;const canA=this.p.gold>=w.cost;return`<div class="shop-item${owned?' owned':''}${!canA&&!owned?' cant-afford':''}" onclick="Game.shopBuyStart('weapon','${w.id}')"><span class="si-name">‚öîÔ∏è ${w.name}${owned?'<span class=shop-equip>„Åù„ÅÜ„Å≥‰∏≠</span>':''}</span><span class="si-desc">${w.desc}</span><span class="si-cost${!canA&&!owned?' expensive':''}">${owned?'---':w.cost+'G'}</span></div>`}).join('')}else{list.innerHTML=SHOP_ITEMS.map(it=>{const qty=this.p.items[it.id]||0;const canA=this.p.gold>=it.cost;return`<div class="shop-item${!canA?' cant-afford':''}" onclick="Game.shopBuyStart('item','${it.id}')"><span class="si-name">üß™ ${it.name}${qty>0?'<span class=item-count>√ó'+qty+'</span>':''}</span><span class="si-desc">${it.desc}</span><span class="si-cost${!canA?' expensive':''}">${it.cost}G</span></div>`}).join('')}},
  shopBuyStart(type,id){
    let item,cost,typingWord;
    if(type==='inn'){if(this.pHp>=this.pMaxHp||this.p.gold<INN_COST)return;item={type:'inn'};cost=INN_COST;typingWord='„ÇÑ„Å©„ÇÑ'}
    else if(type==='weapon'){const w=SHOP_WEAPONS.find(x=>x.id===id);if(!w||this.p.weapon===id||this.p.gold<w.cost)return;item={type:'weapon',...w};cost=w.cost;typingWord=w.name}
    else{const it=SHOP_ITEMS.find(x=>x.id===id);if(!it||this.p.gold<it.cost)return;item={type:'item',...it};cost=it.cost;typingWord=it.name}
    this.shopBuying={item,cost,typingWord};this.shopTypingStart=0;
    const area=document.getElementById('shop-typing-area');area.classList.add('active');
    document.getElementById('shop-buy-label').textContent='> „Äå'+typingWord+'„Äç„Å® „ÅÜ„Å£„Å¶ „Åã„ÅÑ„ÇÇ„ÅÆ! („ÅØ„ÇÑ„ÅÑ„Å® „ÇÑ„Åô„Åè„Å™„Çã)';
    document.getElementById('shop-word-display').innerHTML=typingWord.split('').map(c=>`<span class="char pending">${c}</span>`).join('');
    document.getElementById('discount-msg').textContent='';
    const inp=document.getElementById('shop-input');inp.value='';inp.focus();
    inp.oncompositionstart=()=>{this.composing=true};
    inp.oncompositionend=()=>{this.composing=false;this.checkShopTyping()};
    inp.oninput=()=>{if(!this.shopTypingStart)this.shopTypingStart=Date.now();this.updateShopDisplay();if(!this.composing)this.checkShopTyping()};
  },
  updateShopDisplay(){if(!this.shopBuying)return;const val=document.getElementById('shop-input').value;const tw=this.shopBuying.typingWord;const disp=document.getElementById('shop-word-display');disp.innerHTML=tw.split('').map((c,i)=>{if(i>=val.length)return`<span class="char${i===val.length?' current':' pending'}">${c}</span>`;return`<span class="char ${val[i]===c?'correct':'wrong'}">${c}</span>`}).join('')},
  checkShopTyping(){if(!this.shopBuying)return;const val=document.getElementById('shop-input').value;const tw=this.shopBuying.typingWord;if(val.length<tw.length)return;
    const elapsed=(Date.now()-this.shopTypingStart)/1000;let errors=0;for(let i=0;i<tw.length;i++){if(val[i]!==tw[i])errors++}
    const acc=Math.round(((tw.length-errors)/tw.length)*100);const cpm=elapsed>0?tw.length/elapsed:tw.length;
    let discount=0;
    if(errors===0)discount+=15;
    if(errors===0&&cpm>3)discount+=10;
    if(errors===0&&cpm>5)discount+=10;
    if(cpm>4)discount+=5;
    discount=Math.min(40,discount);
    const origCost=this.shopBuying.cost;const finalCost=Math.max(1,Math.floor(origCost*(1-discount/100)));
    if(this.p.gold<finalCost){document.getElementById('discount-msg').textContent='üí∞„Åå„Åü„Çä„Å™„ÅÑ‚Ä¶';document.getElementById('discount-msg').className='discount-msg fail';return}
    this.p.gold-=finalCost;
    const msg=document.getElementById('discount-msg');
    if(discount>0){msg.textContent=`${acc}% „Åõ„ÅÑ„Åã„Åè! ${discount}%OFF ‚Üí ${finalCost}G (${origCost}G„Åã„Çâ)`;msg.className='discount-msg'}
    else{msg.textContent=`${finalCost}G „Åä„Åã„ÅÑ„ÅÇ„Åí!`;msg.className='discount-msg'}
    const item=this.shopBuying.item;
    if(item.type==='inn'){this.pHp=this.pMaxHp;this.updatePHP();sfxInn()}
    else if(item.type==='weapon'){this.p.weapon=item.id;this.p.atk=item.atk;sfxBuy()}
    else{this.p.items[item.id]=(this.p.items[item.id]||0)+1;sfxBuy()}
    spawnBoom(window.innerWidth/2,window.innerHeight*.4);
    document.getElementById('shop-gold').textContent='üí∞ '+this.p.gold+'G';
    this.save();this.updatePotionBtn();
    document.getElementById('shop-input').value='';
    this.shopBuying=null;
    setTimeout(()=>{document.getElementById('shop-typing-area').classList.remove('active');this.shopTab(document.querySelector('.shop-tab.active').id.replace('tab-',''))},800);
  },
  openShopFromGameover(){this.pHp=Math.floor(this.pMaxHp*.3);this.updatePHP();this.openShop()},
  shopToNext(){this.pHp=Math.min(this.pMaxHp,this.pHp);this.updatePHP();this.stage=Math.min(this.stage+1,5);this.sS=Date.now();this.sW=0;this.sC=0;this.sE=0;this.wIS=0;this.mD=0;this.stageGold=0;mI.value='';this.mOffset=0;this.showScreen('battle-screen');this.spawnM();this.startAtkTimer();setTimeout(()=>this.focusInput(),200)},

  startAtkTimer(){this.stopAtkTimer();this.atkT=0;this.atkInt=setInterval(()=>{if(!document.querySelector('#battle-screen.active'))return;this.atkT+=0.1;this.updateAtkBar();if(this.atkT>=this.atkMax){this.resetAtk();this.monAttack()}},100)},
  stopAtkTimer(){if(this.atkInt){clearInterval(this.atkInt);this.atkInt=null}},
  resetAtk(){this.atkT=0;this.updateAtkBar()},
  updateAtkBar(){const p=Math.min(100,(this.atkT/this.atkMax)*100);const bar=document.getElementById('m-atk');if(!bar)return;bar.style.width=p+'%';bar.className='atk-inner'+(p>80?' danger':p>50?' warn':'')},
  monAttack(){if(this.pHp<=0)return;sfxHit();this.playerDmg(this.atkDmg);const cv=document.getElementById('m-canvas');cv.style.transform='translateY(8px)';setTimeout(()=>{cv.style.transform=''},150)},
  playerDmg(amt){this.pHp=Math.max(0,this.pHp-amt);this.updatePHP();const fl=document.getElementById('dmg-flash');fl.classList.remove('active');fl.offsetHeight;fl.classList.add('active');setTimeout(()=>fl.classList.remove('active'),300);document.body.classList.add('screen-shake');setTimeout(()=>document.body.classList.remove('screen-shake'),400);spawnP(window.innerWidth/2,window.innerHeight*.7,'#d03030',8);if(this.pHp<=0){this.gameOver()}},
  updatePHP(){const el=document.getElementById('s-php');if(!el)return;el.textContent=this.pHp;const pct=this.pHp/this.pMaxHp;el.className='php-txt'+(pct<0.15?' crit':pct<0.35?' low':'')},
  gameOver(){this.stopAtkTimer();sfxBad();setTimeout(()=>sfxBad(),100);setTimeout(()=>snd(80,.3,'sawtooth'),200);const acc=this.sC>0?Math.round(((this.sC-this.sE)/this.sC)*100):100;document.getElementById('gameover-results').innerHTML='<div class="result-item"><div class="label">STAGE</div><div class="value">'+this.stage+'</div></div><div class="result-item"><div class="label">„Åü„Åä„Åó„Åü „Å¶„Åç</div><div class="value">'+this.mD+'</div></div><div class="result-item"><div class="label">„ÅÜ„Å£„Åü „Åì„Å®„Å∞</div><div class="value">'+this.sW+'</div></div><div class="result-item"><div class="label">„Åõ„ÅÑ„Åã„Åè„Åï</div><div class="value">'+acc+'%</div></div>';this.save();this.showScreen('gameover-screen')},
  retryBattle(){this.pHp=this.pMaxHp;this.sS=Date.now();this.sW=0;this.sC=0;this.sE=0;this.wIS=0;this.streak=0;this.mD=0;mI.value='';this.mOffset=0;this.showScreen('battle-screen');this.spawnM();this.startAtkTimer();this.updatePHP();this.updateS();setTimeout(()=>this.focusInput(),200)},
  newGame(){initA();this.p={name:this.p.name||document.getElementById('player-name').value.trim()||'„ÇÜ„ÅÜ„Åó„ÇÉ',level:1,xp:0,xpN:60,wt:0,bW:0,bS:0,tc:0,gold:0,atk:0,weapon:'',items:{}};this.stage=1;this.save();this.startAdventure()},
  updateTitleBtns(){const el=document.getElementById('title-buttons');if(!el)return;const nm=this.p.name||'';const hasSave=this.p.level>1||this.p.wt>0;if(hasSave){const wpn=this.p.weapon?SHOP_WEAPONS.find(w=>w.id===this.p.weapon):null;el.innerHTML='<button class="btn btn-green" onclick="Game.startAdventure()">„Å§„Å•„Åç„Åã„Çâ (Lv'+this.p.level+' üí∞'+this.p.gold+'G'+(wpn?' ‚öîÔ∏è'+wpn.name:'')+')</button><br><button class="btn btn-small" style="margin-top:5px" onclick="Game.newGame()">„ÅØ„Åò„ÇÅ„Åã„Çâ</button>'}else{el.innerHTML='<button class="btn btn-green" onclick="Game.startAdventure()">„Åº„ÅÜ„Åë„Çì„Å´ „Åß„Çã</button>'}},

  save(){localStorage.setItem('tq_p',JSON.stringify(this.p));localStorage.setItem('tq_s',this.stage)},
  load(){const s=localStorage.getItem('tq_p');if(s){const d=JSON.parse(s);this.p=Object.assign({gold:0,atk:0,weapon:'',items:{}},d);if(!this.p.items)this.p.items={}}const t=localStorage.getItem('tq_s');if(t)this.stage=parseInt(t)},
  saveR(w,a){let r=JSON.parse(localStorage.getItem('tq_r')||'[]');r.push({n:this.p.name,l:this.p.level,w,a,s:this.stage,d:new Date().toLocaleDateString('ja-JP')});r.sort((a,b)=>b.w-a.w);r=r.slice(0,20);localStorage.setItem('tq_r',JSON.stringify(r))},
  renderR(){const r=JSON.parse(localStorage.getItem('tq_r')||'[]');const el=document.getElementById('ranking-list');if(!r.length){el.innerHTML='<p style="font-size:8px;color:#606070;text-align:center">„Åæ„Å† „Éá„Éº„Çø„Åå „Å™„ÅÑ„Çà</p>';return}el.innerHTML=r.map((e,i)=>`<div class="rank-entry${e.n===this.p.name?' mine':''}"><span class="rank">${i<3?['1st','2nd','3rd'][i]:(i+1)+'.'}</span><span class="rname">${e.n} Lv${e.l}</span><span class="rscore">${e.w}WPM ${e.a}%</span></div>`).join('')},
  updateV(){let c=parseInt(localStorage.getItem('tq_v')||'0');const lv=localStorage.getItem('tq_lv'),td=new Date().toDateString();if(lv!==td){c++;localStorage.setItem('tq_v',c);localStorage.setItem('tq_lv',td)}document.getElementById('visitor-count').textContent='VISITORS: '+c},
};

Game.init();
</script>
</body>
</html>
